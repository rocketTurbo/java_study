## 1 聚合（统计）函数深入

#### 1-1 理论

###### 1-1-1 聚合函数的特点

```
 count：可能会统计null值，其他不计算null值。
 会导致统计上的纰漏，特别是平均值的查询。
```

###### 1-1-2 ifNULL的使用

```
ifnull的使用
IFNULL(expr1,expr2)
如果expr1不是NULL，IFNULL()返回expr1，否则它返回expr2。IFNULL()返回一个数字或字符串值

即：
 ifnull(score ,0) : 如果score字段的值，不是null，返回score的真实值，否则返回0，而不是null。

```



#### 1-2 准备数据

```
-- 准备数据
create table student（
  name char(10),
  a  int,
  b  int
);
insert into student values('张三',60,60);
insert into student values('李四',70,null);
insert into student values('王五',80,80);

```

#### 1-3 分析下列查询语句

```
select count(a) from student;
-- 结果是:3

select count(b) from student;
-- 结果是:2

select count(*) from student;
-- 结果是:3

SELECT avg(b) FROM student;
-- 结果是：70


// ifnull的使用
select count(ifnull(b, 0)) from student;
-- 结果是:3

SELECT avg(ifnull(b, 0)) FROM student;
-- 结果是:46.6667
```



## 2 去重

#### 2-1 描述

```
学生表的数据，存在除开id不同外，其他字段数据，完全相同的记录，要求，只保留id最小的那天记录。
id	name	sex	tel
1	李四	男	123
2	张三	男	124
3	张三	男	124

```



#### 2-2 准备数据

```
CREATE TABLE `student2` (
  `id` int(11) ,
  `name` char(10) ,
  `sex` char(10) ,
  `tel` char(10),
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;

SELECT * FROM student2; 


INSERT  INTO `student2`(`id`,`name`,`sex`,`tel`) VALUES (1,'李四','男','123');
INSERT  INTO `student2`(`id`,`name`,`sex`,`tel`) VALUES (2,'张三','男','124');
INSERT  INTO `student2`(`id`,`name`,`sex`,`tel`) VALUES (3,'张三','男','124');

```



#### 2-3 答案：注意一个经典错误

```
-- 第一步，找到所有不同的记录的最小id
SELECT  min(id) FROM student2 GROUP BY NAME, sex, tel;  //  集合X

-- 第二步，删除所有不在集合X中的id
DELETE FROM student2 WHERE id NOT IN (X);
--     带入集合X的表达式
DELETE FROM student2 WHERE id NOT IN (SELECT  min(id) FROM student2 GROUP BY NAME, sex, tel);

-- 上面的描述，逻辑正确的，但是mysql不支持，报错信息如下：You can't specify target table 'student2' for update in FROM clause。 
   （大意是：不能先select出同一表中的某些值，再update这个表(在同一语句中)，即不能依据某字段值做判断再来更新某字段的值。）


-- 解决方案：多包裹一层，欺骗mysql

select id from  X;  -- 这句，其实没有任何意义，但是，多包裹一层，可以忽悠mysql
DELETE FROM student2 WHERE id NOT IN (select id from  X);

-- 在带入X 标准答案
DELETE FROM student2 WHERE id NOT IN (select id from  (SELECT  min(id) id FROM student2 GROUP BY NAME, sex, tel)X);

```



## 3 mysql 行列互转

#### 3-1 背景

> a. 在金融项目，管理项目中，需要对数据进行更多的分析和展示，行列互转的需求较多。
>
> b. 笔试常见



#### 3-2 行转列

###### 1-2-1 描述

```
-- 成绩表的原始数据结构
name course	score
张三	语文	88
张三	数学	92
张三	物理	93
李四	语文	79
李四	数学	99
李四	物理	94
王五	语文	34
王五	数学	76
王五	物理	89


-- 要求通过sql语句，查询下列效果
name	语文	数学	物理
张三	  88	92	  93
李四	  79	99	  94
王五	  34	76	  89
```



###### 3-2-2 准备数据

```
DROP TABLE IF EXISTS `score`;
CREATE TABLE `score` (
  `name` varchar(10) DEFAULT NULL,
  `course` varchar(10) DEFAULT NULL,
  `score` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
 
-- ----------------------------
-- Records of score
-- ----------------------------
INSERT INTO `score` VALUES ('张三', '语文', '88');
INSERT INTO `score` VALUES ('张三', '数学', '92');
INSERT INTO `score` VALUES ('张三', '物理', '93');
INSERT INTO `score` VALUES ('李四', '语文', '79');
INSERT INTO `score` VALUES ('李四', '数学', '99');
INSERT INTO `score` VALUES ('李四', '物理', '94');
INSERT INTO `score` VALUES ("王五", "语文", '34');
INSERT INTO `score` VALUES ("王五", "数学", '76');
INSERT INTO `score` VALUES ("王五", "物理", '89');



```



###### 3-2-3 答案

a. 答案1：if

```
SELECT NAME,
SUM(IF(course = '语文',score,0)) AS "语文",
SUM(IF(course = '数学',score,0)) AS "数学",
SUM(IF(course = '物理',score,0)) AS "物理"
FROM score GROUP BY NAME;
```

b. 答案2：case when

```
SELECT NAME,
SUM(CASE WHEN course = '语文' THEN score ELSE 0 END) AS "语文",
SUM(CASE WHEN course = '数学' THEN score ELSE 0 END) AS "数学",
SUM(CASE WHEN course = '物理' THEN score ELSE 0 END) AS "物理"
FROM score GROUP BY NAME;
```





###### 3-2-4 扩展知识：case when的使用

详见：扩展资料

```
mysql 中 case when then .... else end 的简单使用
数据SQL CASE 表达式是一种通用的条件表达式，类似于其它语言中的 if/else 语句。 

CASE WHEN condition THEN result 

　　　WHEN condition THEN result 

　　　.............
　　　[WHEN ...] 
　　　[ELSE result] 
END 

CASE 子句可以用于任何表达式可以有效存在的地方。 condition 是一个返回boolean 的表达式。 如果结果为真，那么 CASE 表达式的结果就是符合条件的 result。 如果结果为假，那么以相同方式搜寻任何随后的 WHEN 子句。 如果没有 WHEN condition 为真，那么 case 表达式的结果就是在 ELSE 子句里的值。 如果省略了 ELSE 子句而且没有匹配的条件， 结果为 NULL。

或其语法为：

简单Case函数 
CASE sex 
         WHEN '1' THEN '男' 
         WHEN '2' THEN '女' 
ELSE '其他' END 


```





#### 3-3 列转行

###### 3-3-1 描述

```
成绩表的原始数据
name	语文	数学	物理
张三	  88	92	  93
李四	  79	99	  94
王五	  34	76	  89


-- 要求通过sql语句，查询下列效果
张三	语文	88
张三	数学	92
张三	物理	93
李四	语文	79
李四	数学	99
李四	物理	94
王五	语文	34
王五	数学	76
王五	物理	89
```



###### 3-3-2 准备数据

```
DROP TABLE IF EXISTS `score1`;
CREATE TABLE `score1` (
  `name` VARCHAR(10) DEFAULT NULL,
  `chinese` INT DEFAULT NULL,
  `math` INT DEFAULT NULL,
  `english` INT DEFAULT NULL
) ENGINE=INNODB DEFAULT CHARSET=utf8;
 
-- ----------------------------
-- Records of score
-- ----------------------------

INSERT INTO `score1` VALUES ('张三', 88, 92,93);
INSERT INTO `score1` VALUES ('李四', 79, 99,94);
INSERT INTO `score1` VALUES ('王五', 34, 76,89);
```



###### 3-2-3 答案

```
a. 先感受下列查询
 SELECT NAME, '语文' COURSE , chinese AS SCORE FROM score1;


b.答案：使用“union”联合查询
 SELECT NAME, '语文' COURSE , chinese AS SCORE FROM score1
 UNION  SELECT NAME, '数学' COURSE , math AS SCORE FROM score1
 UNION  SELECT NAME, '英语' COURSE , english AS SCORE FROM score1;


```

###### 3-2-4 扩展1:一种特别的写法

```
请感受下列查询语句
select  name '姓名' from score1;

select '姓名' name from score1;


```



###### 3-2-5 扩展2：union联合查询

```
把2个select 查询的结果，整合在一起。

有2个关键字：union 和union all
使用Union，则所有返回的行都是唯一的，如同您已经对整个结果集合使用了DISTINCT
使用Union all，则不会排重，返回所有的行

```



## 4  特殊的操作

#### 4-1 求增长率

###### 4-1-1 准备数据，并描述

```
-- 表中的数据为
select * from income;
-----
YEAR	num
2001	100
2002	110
2003	130
2004	120
2005	140


-- 使用sql语句，查询每年相对于上一年的增长率，显示的结果如下：
YEAR  去年收入	今年收入	增长率（%）
2001	null	100	      null
2002	100	    110	      10.0000
2003	110	    130	      18.1818
2004	130	    120	      -7.6923
2005	120	    140	      16.6667
```

###### 4-1-2 准备数据

```
DROP TABLE income;
CREATE TABLE income(YEAR INT, -- 年份
num INT  -- 收入
);
INSERT INTO income VALUES(2001,100);
INSERT INTO income VALUES(2002,110);
INSERT INTO income VALUES(2003,130);
INSERT INTO income VALUES(2004,120);
INSERT INTO income VALUES(2005,140);

```

###### 4-1-3 答案

```
SELECT b.year YEAR , a.num 去年收入 , b.num  今年收入,  (b.num - a.num)/a.num*100  '增长率（%）'  FROM   income  a RIGHT JOIN income b  ON a.year +1 = b.year; 
```

###### 4-1-4 提示

> 自连接





#### 4-2 复制表

###### 4-2-1 描述

```
已存在表A，要求通过表A，创建表B。

要求1：赋值表结构和全部数据
   CREATE TABLE B SELECT *FROM A;


要求1：只复制表结构，不要数据
    CREATE TABLE B SELECT *FROM A where 1=2; 
```



#### 4-3 比赛安排

###### 4-3-1 描述

```
一个叫 team 的表，里面只有一个字段name, 一共有4 条纪录，分别是a,b,c,d, 对应四个球队，现在四个球队进行比赛，用一条sql 语句显示所有可能的比赛组合。

```

###### 4-3-2 准备数据

```
CREATE TABLE team(NAME CHAR(2));
INSERT INTO team VALUES('a');
INSERT INTO team VALUES('b');
INSERT INTO team VALUES('c');
INSERT INTO team VALUES('d');

SELECT *FROM team;
```

###### 4-3-3 答案

```
SELECT a.name 甲, b.name 乙 FROM team a, team  b WHERE a.name>b.name; 
```

###### 4-3-4 提示

> 自连接









